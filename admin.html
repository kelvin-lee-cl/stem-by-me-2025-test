<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STEM-by-ME 2025 - 管理員頁面</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            width: 100%;
            max-width: 1200px;
            min-height: 600px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        /* Login Form Styles */
        .login-form {
            max-width: 400px;
            margin: 0 auto;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease;
            width: 100%;
        }

        .login-btn:hover {
            transform: translateY(-2px);
        }

        .error-message {
            background: #ff6b6b;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        /* Admin Dashboard Styles */
        .admin-dashboard {
            display: none;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .logout-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-weight: bold;
            color: #333;
            font-size: 0.9em;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .refresh-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .export-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .export-btn:hover {
            background: #138496;
        }

        .status-btn {
            background: #6f42c1;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .status-btn:hover {
            background: #5a32a3;
        }

        .info-btn {
            background: #20c997;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .info-btn:hover {
            background: #1ba085;
        }

        /* Status Modal Styles */
        .status-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .status-modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .status-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .status-modal-header h3 {
            color: #333;
            font-size: 1.5em;
            margin: 0;
        }

        .status-modal-close {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        .status-modal-close:hover {
            background: #e55555;
        }

        /* Status Summary Card */
        .status-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 4px solid #667eea;
        }

        .status-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .status-summary-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .status-summary-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }

        .status-stat {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-stat-label {
            font-size: 0.9em;
            color: #666;
        }

        .status-stat-value {
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }

        .status-stat-success {
            background: #d4edda;
            color: #155724;
        }

        .status-stat-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-stat-error {
            background: #f8d7da;
            color: #721c24;
        }

        .status-stat-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* Status Table */
        .status-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .status-table th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }

        .status-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .status-table tr:hover {
            background: #f8f9fa;
        }

        .status-table tr:last-child td {
            border-bottom: none;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.8em;
            text-align: center;
            min-width: 80px;
        }

        .status-badge-success {
            background: #d4edda;
            color: #155724;
        }

        .status-badge-error {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-details {
            font-size: 0.9em;
            color: #666;
            font-style: italic;
            margin-top: 5px;
        }

        /* Legend Styles */
        .legend-section {
            margin-bottom: 30px;
        }

        .legend-section h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .legend-item p {
            margin: 0;
            font-size: 0.9em;
            color: #666;
        }

        .legend-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .legend-list-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .legend-list-item strong {
            color: #333;
            display: block;
            margin-bottom: 5px;
        }

        .legend-list-item p {
            margin: 0;
            font-size: 0.9em;
            color: #666;
        }

        .scores-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .scores-table th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }

        .scores-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .scores-table tr:hover {
            background: #f8f9fa;
        }

        .status-win {
            background: #d4edda;
            color: #155724;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-lose {
            background: #f8d7da;
            color: #721c24;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                min-height: auto;
            }

            .header h1 {
                font-size: 2em;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .filters {
                flex-direction: column;
            }

            .scores-table {
                font-size: 0.9em;
            }

            .scores-table th,
            .scores-table td {
                padding: 8px 10px;
            }

            .status-modal-content {
                margin: 10px;
                width: calc(100% - 20px);
                max-width: none;
            }

            .status-summary-stats {
                flex-direction: column;
                gap: 10px;
            }

            .status-table {
                font-size: 0.9em;
            }

            .status-table th,
            .status-table td {
                padding: 8px 10px;
            }

            .legend-grid {
                grid-template-columns: 1fr;
            }

            .legend-item {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>🎮 STEM-by-ME 2025</h1>
            <p>管理員控制台 / Admin Dashboard</p>
        </div>

        <div class="content">
            <!-- Login Form -->
            <div id="loginForm" class="login-form">
                <h2 style="margin-bottom: 30px; color: #333;">管理員登入</h2>
                <div id="errorMessage" class="error-message"></div>
                <div class="form-group">
                    <label for="adminPassword">管理員密碼</label>
                    <input type="password" id="adminPassword" placeholder="請輸入管理員密碼">
                </div>
                <button class="login-btn" onclick="login()">登入</button>
            </div>

            <!-- Admin Dashboard -->
            <div id="adminDashboard" class="admin-dashboard">
                <div class="dashboard-header">
                    <h2>📊 玩家分數統計</h2>
                    <button class="logout-btn" onclick="logout()">登出</button>
                </div>

                <!-- Statistics -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalPlayers">0</div>
                        <div class="stat-label">總玩家數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalGames">0</div>
                        <div class="stat-label">總遊戲次數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalWins">0</div>
                        <div class="stat-label">總勝利次數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgScore">0</div>
                        <div class="stat-label">平均分數</div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="filters">
                    <div class="filter-group">
                        <label>遊戲篩選</label>
                        <select id="gameFilter">
                            <option value="">所有遊戲</option>
                            <option value="game1">遊戲 1</option>
                            <option value="game2">遊戲 2</option>
                            <option value="game3">遊戲 3</option>
                            <option value="game4">遊戲 4</option>
                            <option value="game5">遊戲 5</option>
                            <option value="game6">遊戲 6</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>狀態篩選</label>
                        <select id="statusFilter">
                            <option value="">所有狀態</option>
                            <option value="win">勝利</option>
                            <option value="lose">失敗</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>玩家名稱</label>
                        <input type="text" id="playerFilter" placeholder="搜尋玩家名稱">
                    </div>
                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <button class="refresh-btn" onclick="loadScores()">🔄 重新整理</button>
                    </div>
                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <button class="export-btn" onclick="exportToExcel()">📊 導出 Excel</button>
                    </div>
                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <button class="status-btn" onclick="checkSystemStatus()">🔍 系統狀態</button>
                    </div>
                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <button class="refresh-btn" onclick="startRealTimeMonitoring()" id="monitorBtn">📡
                            開始實時監測</button>
                    </div>
                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <button class="info-btn" onclick="showStatusLegend()">ℹ️ 狀態說明</button>
                    </div>
                </div>

                <!-- Scores Table -->
                <div id="scoresContainer">
                    <div class="loading">載入中...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Status Modal -->
    <div id="statusModal" class="status-modal">
        <div class="status-modal-content">
            <div class="status-modal-header">
                <h3>🔍 系統狀態檢查</h3>
                <button class="status-modal-close" onclick="closeStatusModal()">&times;</button>
            </div>
            <div id="statusContent">
                <div class="loading">檢查中...</div>
            </div>
        </div>
    </div>

    <!-- Status Legend Modal -->
    <div id="legendModal" class="status-modal">
        <div class="status-modal-content">
            <div class="status-modal-header">
                <h3>ℹ️ 系統狀態說明</h3>
                <button class="status-modal-close" onclick="closeLegendModal()">&times;</button>
            </div>
            <div id="legendContent">
                <div class="legend-section">
                    <h4>🎯 狀態指示器說明</h4>
                    <div class="legend-grid">
                        <div class="legend-item">
                            <span class="status-badge status-badge-success">成功</span>
                            <p>系統功能正常運作，無需任何操作</p>
                        </div>
                        <div class="legend-item">
                            <span class="status-badge status-badge-warning">警告</span>
                            <p>系統功能正常，但需要注意或可能需要關注</p>
                        </div>
                        <div class="legend-item">
                            <span class="status-badge status-badge-error">錯誤</span>
                            <p>系統出現問題，需要立即處理或檢查</p>
                        </div>
                        <div class="legend-item">
                            <span class="status-badge status-badge-info">資訊</span>
                            <p>提供系統相關資訊，通常為正常狀態</p>
                        </div>
                    </div>
                </div>

                <div class="legend-section">
                    <h4>📊 監測項目詳細說明</h4>
                    <div class="legend-list">
                        <div class="legend-list-item">
                            <strong>Firebase 連接</strong>
                            <p>檢查與 Firebase 數據庫的連接狀態。正常表示可以成功讀取和寫入數據，異常表示無法連接數據庫。</p>
                        </div>
                        <div class="legend-list-item">
                            <strong>管理員認證</strong>
                            <p>檢查當前管理員登入狀態。已登入表示可以正常使用管理功能，未登入需要重新輸入密碼。</p>
                        </div>
                        <div class="legend-list-item">
                            <strong>數據可用性</strong>
                            <p>檢查是否有可用的玩家分數數據。顯示已載入的記錄數量，無數據表示尚未有玩家進行遊戲。</p>
                        </div>
                        <div class="legend-list-item">
                            <strong>瀏覽器相容性</strong>
                            <p>檢查瀏覽器是否支援所需功能，包括 Firebase SDK、Excel 導出、本地存儲等。完全支援表示所有功能正常。</p>
                        </div>
                        <div class="legend-list-item">
                            <strong>網路連接</strong>
                            <p>檢查網路連接狀態。在線表示可以正常訪問網路，離線表示網路連接已斷開。</p>
                        </div>
                        <div class="legend-list-item">
                            <strong>記憶體使用</strong>
                            <p>檢查瀏覽器記憶體使用情況。低於80%為正常，80-95%為警告，超過95%為異常。無法檢測表示瀏覽器不支援此功能。</p>
                        </div>
                        <div class="legend-list-item">
                            <strong>最後更新</strong>
                            <p>檢查數據最後更新時間。5分鐘內為「最近更新」，5-30分鐘為「較舊數據」，超過30分鐘為「數據過舊」。數據過舊可能表示系統問題或無玩家活動。</p>
                        </div>
                        <div class="legend-list-item">
                            <strong>活躍用戶</strong>
                            <p>監測過去30分鐘內的活躍用戶數量。顯示活躍用戶數和遊戲次數，0人表示該時段內沒有玩家進行遊戲。</p>
                        </div>
                        <div class="legend-list-item">
                            <strong>最受歡迎遊戲</strong>
                            <p>分析哪個遊戲被玩得最多。顯示遊戲名稱、總遊戲次數和勝率百分比，幫助了解玩家偏好。</p>
                        </div>
                        <div class="legend-list-item">
                            <strong>使用趨勢</strong>
                            <p>比較今日與昨日的使用量變化。上升趨勢表示使用量增加，下降趨勢表示使用量減少，持平表示無變化。</p>
                        </div>
                        <div class="legend-list-item">
                            <strong>高峰使用時段</strong>
                            <p>分析一天中最活躍的使用時段。顯示24小時中遊戲次數最多的時段，幫助了解玩家使用習慣。</p>
                        </div>
                        <div class="legend-list-item">
                            <strong>平均遊戲時長</strong>
                            <p>計算用戶平均遊戲時間。較短（<2分鐘）為警告，正常（2-5分鐘）為成功，較長（>5分鐘）為資訊。基於有時間記錄的遊戲計算。</p>
                        </div>
                    </div>
                </div>

                <div class="legend-section">
                    <h4>🔍 狀態指示器詳細說明</h4>
                    <div class="legend-list">
                        <div class="legend-list-item">
                            <strong>🟢 成功（綠色）</strong>
                            <p>系統功能正常運作，無需任何操作。表示該項目檢查通過，運行良好。</p>
                        </div>
                        <div class="legend-list-item">
                            <strong>🟡 警告（黃色）</strong>
                            <p>系統功能正常，但需要注意或可能需要關注。建議檢查相關設置或等待改善。</p>
                        </div>
                        <div class="legend-list-item">
                            <strong>🔴 錯誤（紅色）</strong>
                            <p>系統出現問題，需要立即處理或檢查。可能影響系統正常運作，建議優先解決。</p>
                        </div>
                        <div class="legend-list-item">
                            <strong>🔵 資訊（藍色）</strong>
                            <p>提供系統相關資訊，通常為正常狀態。用於顯示統計數據或無法檢測的項目。</p>
                        </div>
                    </div>
                </div>

                <div class="legend-section">
                    <h4>💡 常見問題說明</h4>
                    <div class="legend-list">
                        <div class="legend-list-item">
                            <strong>「數據過舊」是什麼意思？</strong>
                            <p>表示最後一次數據更新已超過30分鐘。可能原因：1) 目前沒有玩家進行遊戲（正常情況）；2) 系統無法記錄新數據（需要檢查）；3) 網路或Firebase連接問題。</p>
                        </div>
                        <div class="legend-list-item">
                            <strong>「活躍用戶 0 人」正常嗎？</strong>
                            <p>在非遊戲時間或系統剛部署時是正常的。如果長時間顯示0人且「數據過舊」，建議檢查遊戲頁面是否正常運作。</p>
                        </div>
                        <div class="legend-list-item">
                            <strong>「記憶體使用 無法檢測」怎麼辦？</strong>
                            <p>這是正常的，某些瀏覽器（如Safari）不支援記憶體檢測功能。不影響系統正常運作。</p>
                        </div>
                        <div class="legend-list-item">
                            <strong>「使用趨勢 持平」表示什麼？</strong>
                            <p>表示今日與昨日的遊戲次數相同。在系統剛部署或使用量穩定的情況下是正常的。</p>
                        </div>
                        <div class="legend-list-item">
                            <strong>如何判斷系統是否正常？</strong>
                            <p>查看「整體系統狀態」：綠色「系統正常」表示一切良好；黃色「系統警告」表示需要注意；紅色「系統異常」表示需要立即處理。</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Configuration -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <!-- SheetJS for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD5x_L2yAP9ndQJRBeC31Z6nNrh4okt9uo",
            authDomain: "stem-by-me-app.firebaseapp.com",
            projectId: "stem-by-me-app",
            storageBucket: "stem-by-me-app.firebasestorage.app",
            messagingSenderId: "216736327145",
            appId: "1:216736327145:web:e01721f8e0c6a960a19778",
            measurementId: "G-WWSS5PJVP1"
        };

        // Initialize Firebase
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
        }

        // Admin password
        const ADMIN_PASSWORD = 'ADMIN2025';

        // Global variables
        let allScores = [];
        let isAuthenticated = false;

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', function () {
            checkAuthStatus();

            // Add event listeners for filters
            const gameFilter = document.getElementById('gameFilter');
            const statusFilter = document.getElementById('statusFilter');
            const playerFilter = document.getElementById('playerFilter');
            const adminPassword = document.getElementById('adminPassword');

            if (gameFilter) {
                gameFilter.addEventListener('change', displayScores);
            }
            if (statusFilter) {
                statusFilter.addEventListener('change', displayScores);
            }
            if (playerFilter) {
                playerFilter.addEventListener('input', displayScores);
            }
            if (adminPassword) {
                adminPassword.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        login();
                    }
                });
            }
        });

        function checkAuthStatus() {
            const authStatus = sessionStorage.getItem('adminAuthStatus');
            if (authStatus === 'authenticated') {
                isAuthenticated = true;
                showDashboard();
                loadScores();
            } else {
                showLoginForm();
            }
        }

        function login() {
            const password = document.getElementById('adminPassword').value;
            const errorMessage = document.getElementById('errorMessage');

            if (password === ADMIN_PASSWORD) {
                isAuthenticated = true;
                sessionStorage.setItem('adminAuthStatus', 'authenticated');
                showDashboard();
                loadScores();
                errorMessage.style.display = 'none';
            } else {
                errorMessage.textContent = '密碼錯誤，請重新輸入';
                errorMessage.style.display = 'block';
                document.getElementById('adminPassword').value = '';
            }
        }

        function logout() {
            isAuthenticated = false;
            sessionStorage.removeItem('adminAuthStatus');
            showLoginForm();
        }

        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('adminDashboard').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
        }

        async function loadScores() {
            const container = document.getElementById('scoresContainer');
            container.innerHTML = '<div class="loading">載入中...</div>';

            try {
                if (!db) {
                    throw new Error('Firebase not initialized');
                }

                const scoresRef = db.collection('gameScores');
                const snapshot = await scoresRef.orderBy('timestamp', 'desc').get();

                allScores = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    let timestamp;
                    try {
                        timestamp = data.timestamp && typeof data.timestamp.toDate === 'function'
                            ? data.timestamp.toDate()
                            : new Date();
                    } catch (error) {
                        console.warn('Error converting timestamp:', error);
                        timestamp = new Date();
                    }

                    allScores.push({
                        id: doc.id,
                        ...data,
                        timestamp: timestamp
                    });
                });

                updateStatistics();
                displayScores();

            } catch (error) {
                console.error('Error loading scores:', error);
                container.innerHTML = '<div class="no-data">載入失敗: ' + error.message + '</div>';
            }
        }

        function updateStatistics() {
            const totalPlayers = new Set(allScores.map(score => score.playerName)).size;
            const totalGames = allScores.length;
            const totalWins = allScores.filter(score => score.status === 'win').length;
            const avgScore = totalGames > 0 ? Math.round(allScores.reduce((sum, score) => sum + score.score, 0) / totalGames) : 0;

            document.getElementById('totalPlayers').textContent = totalPlayers;
            document.getElementById('totalGames').textContent = totalGames;
            document.getElementById('totalWins').textContent = totalWins;
            document.getElementById('avgScore').textContent = avgScore;
        }

        function displayScores() {
            const gameFilter = document.getElementById('gameFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const playerFilter = document.getElementById('playerFilter').value.toLowerCase();

            let filteredScores = allScores.filter(score => {
                const matchGame = !gameFilter || score.gameId === gameFilter;
                const matchStatus = !statusFilter || score.status === statusFilter;
                const matchPlayer = !playerFilter || score.playerName.toLowerCase().includes(playerFilter);
                return matchGame && matchStatus && matchPlayer;
            });

            const container = document.getElementById('scoresContainer');

            if (filteredScores.length === 0) {
                container.innerHTML = '<div class="no-data">沒有找到符合條件的記錄</div>';
                return;
            }

            let tableHTML = `
                <table class="scores-table">
                    <thead>
                        <tr>
                            <th>玩家名稱</th>
                            <th>遊戲</th>
                            <th>分數</th>
                            <th>狀態</th>
                            <th>遊戲時間</th>
                            <th>總分</th>
                            <th>時間戳</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            filteredScores.forEach(score => {
                const gameName = score.gameId ? `遊戲 ${score.gameId.replace('game', '')}` : '未知遊戲';
                const statusClass = score.status === 'win' ? 'status-win' : 'status-lose';
                const statusText = score.status === 'win' ? '勝利' : '失敗';
                const gameTime = score.gameTime ? `${Math.round(score.gameTime)}秒` : 'N/A';
                let timestamp;
                try {
                    timestamp = score.timestamp && typeof score.timestamp.toLocaleString === 'function'
                        ? score.timestamp.toLocaleString('zh-TW')
                        : 'N/A';
                } catch (error) {
                    console.warn('Error formatting timestamp:', error);
                    timestamp = 'N/A';
                }

                tableHTML += `
                    <tr>
                        <td>${score.playerName || '匿名玩家'}</td>
                        <td>${gameName}</td>
                        <td>${score.score}</td>
                        <td><span class="${statusClass}">${statusText}</span></td>
                        <td>${gameTime}</td>
                        <td>${score.totalScore || score.score}</td>
                        <td>${timestamp}</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        // System Status Check function
        async function checkSystemStatus() {
            const modal = document.getElementById('statusModal');
            const content = document.getElementById('statusContent');

            modal.style.display = 'block';
            content.innerHTML = '<div class="loading">🔍 正在進行全面系統檢查...</div>';

            const statusChecks = [];

            // 1. Check Firebase Connection
            try {
                if (!db) {
                    statusChecks.push({
                        label: 'Firebase 連接',
                        status: 'error',
                        value: '未初始化',
                        details: 'Firebase 數據庫未正確初始化'
                    });
                } else {
                    // Test Firebase connection
                    const testRef = db.collection('gameScores');
                    const testSnapshot = await testRef.limit(1).get();

                    statusChecks.push({
                        label: 'Firebase 連接',
                        status: 'success',
                        value: '正常',
                        details: '成功連接到 Firebase Firestore'
                    });
                }
            } catch (error) {
                statusChecks.push({
                    label: 'Firebase 連接',
                    status: 'error',
                    value: '連接失敗',
                    details: `錯誤: ${error.message}`
                });
            }

            // 2. Check Authentication Status
            const authStatus = sessionStorage.getItem('adminAuthStatus');
            statusChecks.push({
                label: '管理員認證',
                status: authStatus === 'authenticated' ? 'success' : 'warning',
                value: authStatus === 'authenticated' ? '已登入' : '未登入',
                details: authStatus === 'authenticated' ? '管理員已成功登入' : '需要重新登入'
            });

            // 3. Check Data Availability
            try {
                if (allScores.length > 0) {
                    statusChecks.push({
                        label: '數據可用性',
                        status: 'success',
                        value: `${allScores.length} 筆記錄`,
                        details: `已載入 ${allScores.length} 筆玩家分數記錄`
                    });
                } else {
                    statusChecks.push({
                        label: '數據可用性',
                        status: 'warning',
                        value: '無數據',
                        details: '尚未載入任何玩家分數記錄'
                    });
                }
            } catch (error) {
                statusChecks.push({
                    label: '數據可用性',
                    status: 'error',
                    value: '載入失敗',
                    details: `錯誤: ${error.message}`
                });
            }

            // 4. Check Browser Compatibility
            const browserChecks = [];

            // Check if Firebase is available
            if (typeof firebase !== 'undefined') {
                browserChecks.push('Firebase SDK ✓');
            } else {
                browserChecks.push('Firebase SDK ✗');
            }

            // Check if XLSX is available
            if (typeof XLSX !== 'undefined') {
                browserChecks.push('Excel 導出 ✓');
            } else {
                browserChecks.push('Excel 導出 ✗');
            }

            // Check localStorage support
            if (typeof localStorage !== 'undefined') {
                browserChecks.push('本地存儲 ✓');
            } else {
                browserChecks.push('本地存儲 ✗');
            }

            // Check sessionStorage support
            if (typeof sessionStorage !== 'undefined') {
                browserChecks.push('會話存儲 ✓');
            } else {
                browserChecks.push('會話存儲 ✗');
            }

            const browserStatus = browserChecks.every(check => check.includes('✓')) ? 'success' : 'warning';
            const browserValue = browserChecks.every(check => check.includes('✓')) ? '完全支援' : '部分支援';

            statusChecks.push({
                label: '瀏覽器相容性',
                status: browserStatus,
                value: browserValue,
                details: browserChecks.join(', ')
            });

            // 5. Check Network Status
            if (navigator.onLine) {
                statusChecks.push({
                    label: '網路連接',
                    status: 'success',
                    value: '在線',
                    details: '網路連接正常'
                });
            } else {
                statusChecks.push({
                    label: '網路連接',
                    status: 'error',
                    value: '離線',
                    details: '網路連接已斷開'
                });
            }

            // 6. Check System Performance
            const memoryInfo = performance.memory ? {
                used: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024),
                total: Math.round(performance.memory.totalJSHeapSize / 1024 / 1024),
                limit: Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024)
            } : null;

            if (memoryInfo) {
                const memoryUsage = Math.round((memoryInfo.used / memoryInfo.limit) * 100);
                const memoryStatus = memoryUsage < 80 ? 'success' : memoryUsage < 95 ? 'warning' : 'error';

                statusChecks.push({
                    label: '記憶體使用',
                    status: memoryStatus,
                    value: `${memoryUsage}%`,
                    details: `已使用 ${memoryInfo.used}MB / ${memoryInfo.limit}MB`
                });
            } else {
                statusChecks.push({
                    label: '記憶體使用',
                    status: 'info',
                    value: '無法檢測',
                    details: '瀏覽器不支援記憶體資訊檢測'
                });
            }

            // 7. Check Last Data Update
            if (allScores.length > 0) {
                const latestScore = allScores[0];
                const lastUpdate = latestScore.timestamp;
                const timeDiff = Date.now() - lastUpdate.getTime();
                const minutesDiff = Math.round(timeDiff / 1000 / 60);

                let updateStatus, updateValue, updateDetails;

                if (minutesDiff < 5) {
                    updateStatus = 'success';
                    updateValue = '最近更新';
                    updateDetails = `${minutesDiff} 分鐘前`;
                } else if (minutesDiff < 30) {
                    updateStatus = 'warning';
                    updateValue = '較舊數據';
                    updateDetails = `${minutesDiff} 分鐘前`;
                } else {
                    updateStatus = 'error';
                    updateValue = '數據過舊';
                    updateDetails = `${minutesDiff} 分鐘前`;
                }

                statusChecks.push({
                    label: '最後更新',
                    status: updateStatus,
                    value: updateValue,
                    details: updateDetails
                });
            } else {
                statusChecks.push({
                    label: '最後更新',
                    status: 'info',
                    value: '無數據',
                    details: '尚未載入任何數據'
                });
            }

            // 8. Check Active Users (Real-time monitoring)
            try {
                const recentScores = allScores.filter(score => {
                    const scoreTime = score.timestamp.getTime();
                    const timeDiff = Date.now() - scoreTime;
                    return timeDiff < 30 * 60 * 1000; // Last 30 minutes
                });

                const activeUsers = new Set(recentScores.map(score => score.playerName)).size;
                const recentGames = recentScores.length;

                if (activeUsers > 0) {
                    statusChecks.push({
                        label: '活躍用戶',
                        status: 'success',
                        value: `${activeUsers} 人`,
                        details: `過去30分鐘內有 ${activeUsers} 位用戶進行了 ${recentGames} 場遊戲`
                    });
                } else {
                    statusChecks.push({
                        label: '活躍用戶',
                        status: 'warning',
                        value: '0 人',
                        details: '過去30分鐘內沒有用戶活動'
                    });
                }
            } catch (error) {
                statusChecks.push({
                    label: '活躍用戶',
                    status: 'error',
                    value: '檢測失敗',
                    details: `錯誤: ${error.message}`
                });
            }

            // 9. Check Game Activity Distribution
            try {
                const gameStats = {};
                allScores.forEach(score => {
                    const gameId = score.gameId || 'unknown';
                    if (!gameStats[gameId]) {
                        gameStats[gameId] = { total: 0, wins: 0 };
                    }
                    gameStats[gameId].total++;
                    if (score.status === 'win') {
                        gameStats[gameId].wins++;
                    }
                });

                const mostPlayedGame = Object.entries(gameStats)
                    .sort(([, a], [, b]) => b.total - a.total)[0];

                if (mostPlayedGame) {
                    const [gameId, stats] = mostPlayedGame;
                    const gameName = gameId === 'unknown' ? '未知遊戲' : `遊戲 ${gameId.replace('game', '')}`;
                    const winRate = Math.round((stats.wins / stats.total) * 100);

                    statusChecks.push({
                        label: '最受歡迎遊戲',
                        status: 'info',
                        value: gameName,
                        details: `總遊戲次數: ${stats.total}, 勝率: ${winRate}%`
                    });
                } else {
                    statusChecks.push({
                        label: '最受歡迎遊戲',
                        status: 'info',
                        value: '無數據',
                        details: '尚未有遊戲記錄'
                    });
                }
            } catch (error) {
                statusChecks.push({
                    label: '最受歡迎遊戲',
                    status: 'error',
                    value: '分析失敗',
                    details: `錯誤: ${error.message}`
                });
            }

            // 10. Check System Performance Trends
            try {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const todayScores = allScores.filter(score => {
                    const scoreDate = new Date(score.timestamp);
                    scoreDate.setHours(0, 0, 0, 0);
                    return scoreDate.getTime() === today.getTime();
                });

                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);

                const yesterdayScores = allScores.filter(score => {
                    const scoreDate = new Date(score.timestamp);
                    scoreDate.setHours(0, 0, 0, 0);
                    return scoreDate.getTime() === yesterday.getTime();
                });

                const todayGames = todayScores.length;
                const yesterdayGames = yesterdayScores.length;

                let trendStatus, trendValue, trendDetails;

                if (todayGames > yesterdayGames) {
                    const increase = Math.round(((todayGames - yesterdayGames) / yesterdayGames) * 100);
                    trendStatus = 'success';
                    trendValue = '上升趨勢';
                    trendDetails = `今日 ${todayGames} 場 vs 昨日 ${yesterdayGames} 場 (+${increase}%)`;
                } else if (todayGames < yesterdayGames) {
                    const decrease = Math.round(((yesterdayGames - todayGames) / yesterdayGames) * 100);
                    trendStatus = 'warning';
                    trendValue = '下降趨勢';
                    trendDetails = `今日 ${todayGames} 場 vs 昨日 ${yesterdayGames} 場 (-${decrease}%)`;
                } else {
                    trendStatus = 'info';
                    trendValue = '持平';
                    trendDetails = `今日 ${todayGames} 場 vs 昨日 ${yesterdayGames} 場 (0%)`;
                }

                statusChecks.push({
                    label: '使用趨勢',
                    status: trendStatus,
                    value: trendValue,
                    details: trendDetails
                });
            } catch (error) {
                statusChecks.push({
                    label: '使用趨勢',
                    status: 'error',
                    value: '分析失敗',
                    details: `錯誤: ${error.message}`
                });
            }

            // 11. Check Peak Usage Times
            try {
                const hourStats = new Array(24).fill(0);
                allScores.forEach(score => {
                    const hour = score.timestamp.getHours();
                    hourStats[hour]++;
                });

                const peakHour = hourStats.indexOf(Math.max(...hourStats));
                const peakGames = hourStats[peakHour];

                if (peakGames > 0) {
                    statusChecks.push({
                        label: '高峰使用時段',
                        status: 'info',
                        value: `${peakHour}:00`,
                        details: `該時段有 ${peakGames} 場遊戲，為最活躍時段`
                    });
                } else {
                    statusChecks.push({
                        label: '高峰使用時段',
                        status: 'info',
                        value: '無數據',
                        details: '尚未有足夠的遊戲記錄來分析使用時段'
                    });
                }
            } catch (error) {
                statusChecks.push({
                    label: '高峰使用時段',
                    status: 'error',
                    value: '分析失敗',
                    details: `錯誤: ${error.message}`
                });
            }

            // 12. Check Average Session Duration
            try {
                const sessionsWithTime = allScores.filter(score => score.gameTime && score.gameTime > 0);

                if (sessionsWithTime.length > 0) {
                    const avgSessionTime = sessionsWithTime.reduce((sum, score) => sum + score.gameTime, 0) / sessionsWithTime.length;
                    const avgMinutes = Math.round(avgSessionTime / 60 * 10) / 10;

                    let sessionStatus, sessionValue;
                    if (avgMinutes < 2) {
                        sessionStatus = 'warning';
                        sessionValue = '較短';
                    } else if (avgMinutes < 5) {
                        sessionStatus = 'success';
                        sessionValue = '正常';
                    } else {
                        sessionStatus = 'info';
                        sessionValue = '較長';
                    }

                    statusChecks.push({
                        label: '平均遊戲時長',
                        status: sessionStatus,
                        value: sessionValue,
                        details: `平均 ${avgMinutes} 分鐘 (基於 ${sessionsWithTime.length} 場遊戲)`
                    });
                } else {
                    statusChecks.push({
                        label: '平均遊戲時長',
                        status: 'info',
                        value: '無數據',
                        details: '沒有記錄遊戲時長的數據'
                    });
                }
            } catch (error) {
                statusChecks.push({
                    label: '平均遊戲時長',
                    status: 'error',
                    value: '分析失敗',
                    details: `錯誤: ${error.message}`
                });
            }

            // Calculate summary statistics
            const successCount = statusChecks.filter(check => check.status === 'success').length;
            const errorCount = statusChecks.filter(check => check.status === 'error').length;
            const warningCount = statusChecks.filter(check => check.status === 'warning').length;
            const infoCount = statusChecks.filter(check => check.status === 'info').length;

            const overallStatus = errorCount > 0 ? 'error' : warningCount > 0 ? 'warning' : 'success';
            const overallValue = errorCount > 0 ? '系統異常' : warningCount > 0 ? '系統警告' : '系統正常';

            // Create summary card
            let statusHTML = `
                <div class="status-summary">
                    <div class="status-summary-header">
                        <div class="status-summary-title">整體系統狀態</div>
                        <div class="status-badge status-badge-${overallStatus}">${overallValue}</div>
                    </div>
                    <div class="status-summary-stats">
                        <div class="status-stat">
                            <span class="status-stat-label">成功:</span>
                            <span class="status-stat-value status-stat-success">${successCount}</span>
                        </div>
                        <div class="status-stat">
                            <span class="status-stat-label">警告:</span>
                            <span class="status-stat-value status-stat-warning">${warningCount}</span>
                        </div>
                        <div class="status-stat">
                            <span class="status-stat-label">錯誤:</span>
                            <span class="status-stat-value status-stat-error">${errorCount}</span>
                        </div>
                        <div class="status-stat">
                            <span class="status-stat-label">資訊:</span>
                            <span class="status-stat-value status-stat-info">${infoCount}</span>
                        </div>
                    </div>
                </div>
            `;

            // Create status table
            statusHTML += `
                <table class="status-table">
                    <thead>
                        <tr>
                            <th>檢查項目</th>
                            <th>狀態</th>
                            <th>詳細資訊</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            statusChecks.forEach(check => {
                statusHTML += `
                    <tr>
                        <td><strong>${check.label}</strong></td>
                        <td><span class="status-badge status-badge-${check.status}">${check.value}</span></td>
                        <td>
                            <div>${check.details}</div>
                        </td>
                    </tr>
                `;
            });

            statusHTML += '</tbody></table>';

            content.innerHTML = statusHTML;
        }

        function closeStatusModal() {
            document.getElementById('statusModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const statusModal = document.getElementById('statusModal');
            const legendModal = document.getElementById('legendModal');

            if (event.target === statusModal) {
                closeStatusModal();
            }
            if (event.target === legendModal) {
                closeLegendModal();
            }
        }

        // Real-time monitoring variables
        let monitoringInterval = null;
        let isMonitoring = false;

        // Real-time monitoring function
        function startRealTimeMonitoring() {
            const monitorBtn = document.getElementById('monitorBtn');

            if (!isMonitoring) {
                // Start monitoring
                isMonitoring = true;
                monitorBtn.textContent = '⏹️ 停止實時監測';
                monitorBtn.style.background = '#dc3545';

                // Set up interval for real-time updates (every 30 seconds)
                monitoringInterval = setInterval(() => {
                    loadScores().then(() => {
                        // Only update statistics, don't auto-open status modal
                        updateStatistics();
                        displayScores();
                    });
                }, 30000); // 30 seconds

                // Show notification
                showNotification('實時監測已啟動', '系統將每30秒自動更新數據', 'success');
            } else {
                // Stop monitoring
                isMonitoring = false;
                monitorBtn.textContent = '📡 開始實時監測';
                monitorBtn.style.background = '#28a745';

                if (monitoringInterval) {
                    clearInterval(monitoringInterval);
                    monitoringInterval = null;
                }

                // Show notification
                showNotification('實時監測已停止', '系統狀態監測已關閉', 'info');
            }
        }

        // Show status legend function
        function showStatusLegend() {
            const modal = document.getElementById('legendModal');
            modal.style.display = 'block';
        }

        // Close legend modal function
        function closeLegendModal() {
            document.getElementById('legendModal').style.display = 'none';
        }

        // Notification function
        function showNotification(title, message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#d1ecf1'};
                color: ${type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#0c5460'};
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10001;
                max-width: 300px;
                font-family: Arial, sans-serif;
                border-left: 4px solid ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
            `;

            notification.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 5px;">${title}</div>
                <div style="font-size: 0.9em;">${message}</div>
            `;

            document.body.appendChild(notification);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        // Export to Excel function
        function exportToExcel() {
            try {
                // Get current filtered scores
                const gameFilter = document.getElementById('gameFilter').value;
                const statusFilter = document.getElementById('statusFilter').value;
                const playerFilter = document.getElementById('playerFilter').value.toLowerCase();

                let filteredScores = allScores.filter(score => {
                    const matchGame = !gameFilter || score.gameId === gameFilter;
                    const matchStatus = !statusFilter || score.status === statusFilter;
                    const matchPlayer = !playerFilter || score.playerName.toLowerCase().includes(playerFilter);
                    return matchGame && matchStatus && matchPlayer;
                });

                if (filteredScores.length === 0) {
                    alert('沒有數據可以導出！');
                    return;
                }

                // Prepare data for Excel
                const excelData = filteredScores.map(score => {
                    let timestamp;
                    try {
                        timestamp = score.timestamp && typeof score.timestamp.toLocaleString === 'function'
                            ? score.timestamp.toLocaleString('zh-TW')
                            : 'N/A';
                    } catch (error) {
                        timestamp = 'N/A';
                    }

                    return {
                        '玩家名稱': score.playerName || '匿名玩家',
                        '遊戲': score.gameId ? `遊戲 ${score.gameId.replace('game', '')}` : '未知遊戲',
                        '分數': score.score,
                        '狀態': score.status === 'win' ? '勝利' : '失敗',
                        '遊戲時間(秒)': score.gameTime ? Math.round(score.gameTime) : 'N/A',
                        '總分': score.totalScore || score.score,
                        '時間戳': timestamp
                    };
                });

                // Create workbook and worksheet
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);

                // Set column widths
                const colWidths = [
                    { wch: 15 }, // 玩家名稱
                    { wch: 10 }, // 遊戲
                    { wch: 8 },  // 分數
                    { wch: 8 },  // 狀態
                    { wch: 12 }, // 遊戲時間
                    { wch: 8 },  // 總分
                    { wch: 20 }  // 時間戳
                ];
                ws['!cols'] = colWidths;

                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, '玩家分數統計');

                // Generate filename with current date
                const now = new Date();
                const dateStr = now.getFullYear() +
                    String(now.getMonth() + 1).padStart(2, '0') +
                    String(now.getDate()).padStart(2, '0') + '_' +
                    String(now.getHours()).padStart(2, '0') +
                    String(now.getMinutes()).padStart(2, '0');

                const filename = `STEM-by-ME_玩家分數統計_${dateStr}.xlsx`;

                // Export the file
                XLSX.writeFile(wb, filename);

                // Show success message
                alert(`✅ Excel 文件已成功導出！\n文件名：${filename}\n記錄數：${filteredScores.length} 筆`);

            } catch (error) {
                console.error('Export to Excel error:', error);
                alert('❌ 導出 Excel 時發生錯誤：' + error.message);
            }
        }


    </script>
</body>

</html>